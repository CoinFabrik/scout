"use strict";(self.webpackChunkscout=self.webpackChunkscout||[]).push([[3372],{9613:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>g});var n=a(9496);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,r=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),d=c(a),m=l,g=d["".concat(s,".").concat(m)]||d[m]||p[m]||r;return a?n.createElement(g,i(i({ref:t},u),{},{components:a})):n.createElement(g,i({ref:t},u))}));function g(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var r=a.length,i=new Array(r);i[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[d]="string"==typeof e?e:l,i[1]=o;for(var c=2;c<r;c++)i[c]=a[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},234:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var n=a(2564),l=(a(9496),a(9613));const r={},i="Delegate call",o={unversionedId:"vulnerabilities/delegate-call",id:"vulnerabilities/delegate-call",title:"Delegate call",description:"Description",source:"@site/docs/vulnerabilities/11-delegate-call.md",sourceDirName:"vulnerabilities",slug:"/vulnerabilities/delegate-call",permalink:"/scout/docs/vulnerabilities/delegate-call",draft:!1,editUrl:"https://github.com/CoinFabrik/scout/docs/vulnerabilities/11-delegate-call.md",tags:[],version:"current",sidebarPosition:11,frontMatter:{},sidebar:"docsSidebar",previous:{title:"Divide before multiply",permalink:"/scout/docs/vulnerabilities/divide-before-multiply"},next:{title:"Zero or test address",permalink:"/scout/docs/vulnerabilities/zero-or-test-address"}},s={},c=[{value:"Description",id:"description",level:2},{value:"Exploit Scenario",id:"exploit-scenario",level:2},{value:"Remediation",id:"remediation",level:2},{value:"References",id:"references",level:2}],u={toc:c},d="wrapper";function p(e){let{components:t,...a}=e;return(0,l.kt)(d,(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"delegate-call"},"Delegate call"),(0,l.kt)("h2",{id:"description"},"Description"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Vulnerability Category: ",(0,l.kt)("inlineCode",{parentName:"li"},"Authorization")),(0,l.kt)("li",{parentName:"ul"},"Vulnerability Severity: ",(0,l.kt)("inlineCode",{parentName:"li"},"Critical")),(0,l.kt)("li",{parentName:"ul"},"Detectors: ",(0,l.kt)("a",{parentName:"li",href:"https://github.com/CoinFabrik/scout/tree/main/detectors/delegate-call"},(0,l.kt)("inlineCode",{parentName:"a"},"delegate-call"))),(0,l.kt)("li",{parentName:"ul"},"Test Cases: ",(0,l.kt)("a",{parentName:"li",href:"https://github.com/CoinFabrik/scout/tree/main/test-cases/delegate-call/delegate-call-1"},(0,l.kt)("inlineCode",{parentName:"a"},"delegate-call-1")))),(0,l.kt)("p",null,"Delegate calls can introduce security vulnerabilities if not handled carefully. The main idea is that delegate calls to contracts passed as arguments can be used to change the expected behavior of the contract, leading to potential attacks. It is important to validate and restrict delegate calls to trusted contracts, implement proper access control mechanisms, and carefully review external contracts to prevent unauthorized modifications, unexpected behavior, and potential exploits. By following these best practices, developers can enhance the security of their smart contracts and mitigate the risks associated with delegate calls."),(0,l.kt)("h2",{id:"exploit-scenario"},"Exploit Scenario"),(0,l.kt)("p",null,"Consider the following ",(0,l.kt)("inlineCode",{parentName:"p"},"ink!")," contract:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-rust"},"#[ink(message)]\npub fn delegate_call(&mut self, target: Hash, argument: Balance) {\n    let selector_bytes = [0x0, 0x0, 0x0, 0x0];\n    let result: T  = build_call::<DefaultEnvironment>()\n        .delegate(target)\n        .exec_input(\n            ExecutionInput::new(Selector::new(selector_bytes))\n                .push_arg(argument)\n        )\n        .returns::<T>()\n        .invoke();\n}\n")),(0,l.kt)("p",null,"In this example, the ",(0,l.kt)("inlineCode",{parentName:"p"},"delegate_call")," function allows for delegated calls to contracts passed as arguments without any validation or access control. This creates a vulnerability as it enables potential attackers to pass a malicious contract as the target, leading to unauthorized modifications or unexpected behavior in the smart contract."),(0,l.kt)("p",null,"The vulnerable code example can be found ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/CoinFabrik/scout/tree/main/test-cases/delegate-call/delegate-call-1/vulnerable-example"},(0,l.kt)("inlineCode",{parentName:"a"},"here")),"."),(0,l.kt)("h2",{id:"remediation"},"Remediation"),(0,l.kt)("p",null,"In the following remediated example, the vulnerability is addressed by removing the ability to pass the target contract as an argument in the ",(0,l.kt)("inlineCode",{parentName:"p"},"delegate_call")," function. Instead, the target contract address is stored in a storage variable ",(0,l.kt)("inlineCode",{parentName:"p"},"self.target"),", which can only be modified by calling the ",(0,l.kt)("inlineCode",{parentName:"p"},"set_target")," function. The ",(0,l.kt)("inlineCode",{parentName:"p"},"set_target")," function includes access control logic, allowing only the contract's administrator to update the target contract address. This remediation ensures that only trusted and authorized contracts can be delegated to, preventing the vulnerability associated with unvalidated and uncontrolled delegate calls."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-rust"},"    #[ink(message)]\n    pub fn delegate_call(&mut self, argument: Balance) {\n        let selector_bytes = [0x0, 0x0, 0x0, 0x0];\n        let result: T  = build_call::<DefaultEnvironment>()\n            .delegate(self.target)\n            .exec_input(\n                ExecutionInput::new(Selector::new(selector_bytes))\n                    .push_arg(argument)\n            )\n            .returns::<T>()\n            .invoke();\n    }\n\n    #[ink::message]\n    pub fn set_target(&mut self, new_target: Hash) -> Result<(), Error> {\n        if self.admin != self.env().caller() {\n            Err(Error::Unauthorized)\n        } else {\n            self.target = new_target;\n            Ok(())\n        }\n    }\n\n")),(0,l.kt)("p",null,"The remediated code example can be found ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/CoinFabrik/scout/tree/main/test-cases/delegate-call/delegate-call-1/remediated-example"},(0,l.kt)("inlineCode",{parentName:"a"},"here")),"."),(0,l.kt)("h2",{id:"references"},"References"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://solidity-by-example.org/delegatecall/"},"https://solidity-by-example.org/delegatecall/")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://solidity-by-example.org/hacks/delegatecall/"},"https://solidity-by-example.org/hacks/delegatecall/")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://blog.sigmaprime.io/solidity-security.html#delegatecall"},"https://blog.sigmaprime.io/solidity-security.html#delegatecall")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://swcregistry.io/docs/SWC-112"},"SWC-112")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/OpenZeppelin/ethernaut/blob/master/contracts/src/levels/Delegation.sol"},"Ethernaut: Delegation")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/crytic/slither/wiki/Detector-Documentation#controlled-delegatecall"},"Slither: Delegatecall"))))}p.isMDXComponent=!0}}]);